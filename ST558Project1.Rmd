---
title: "National Hockey League (NHL) Vignette"
author: "Maggie Feng"
date: "June 20, 2021"
output: 
  github_document:
    toc: true
---

```{r setup, include = FALSE}
#To create vignette
#devtools::build_vignettes()
```

Required packages to run this vignette:

```{r, message = FALSE}
library(httr)
library(jsonlite)
library(tidyverse)
library(ggplot2)
library(knitr)
```

# Functions to read in the data

## NHL records API

The `getRecords` function will contact the [NHL records API](https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md), pull data from one of the six endpoints, and output a data frame.

The first argument `input` is to specify one of the six endpoints: 

* `"franchise"` will return id, firstSeasonId, lastSeasonId, and name of every team in the history of the NHL
* `"teamtotal"` will return the total stats for every franchise
* `"season"` will drill-down into season records and can do so for a specific franchise
* `"goalie"` will return goalie records for all or a specified franchise
* `"skater"` will return skater records for all or a specified franchise
* `"history"` will return admin history and retired numbers

The arguments `name` and `id` are used to specify which team or franchise's records you wish to output. Adding `name` or `id` for the first two endpoints, `"franchise"` and `"teamtotal"`, will have the same result of not adding the arguments at all. 

```{r}
#Function to contact the NHL records API
#returns well-formatted, parsed data
getRecords <- function(input = c("franchise", "teamtotal", "season", "goalie", "skater", "history"), 
                       name = NULL, id = NULL){
  ##Note: if both team name and id arguments are filled, team name overrides id number
  
  #All queries are prefixed by this base_url
  base_url <- "https://records.nhl.com/site/api"
  
  #First two endpoints: do not have name/id specification
  if (input == "franchise" | input == "teamtotal"){
    if (input == "franchise")
      endpoint <- "franchise"
    if (input == "teamtotal")
      endpoint <- "franchise-team-totals"
    full_url <- paste0(base_url, "/", endpoint)
  }
  
  #Third, fourth, and fifth endpoints: with name/id specification by franchiseId
  if (input == "season" | input == "goalie" | input == "skater"){
    if (input == "season")
      endpoint <- "franchise-season-records"
    if (input == "goalie")
      endpoint <- "franchise-goalie-records"
    if (input == "skater")
      endpoint <- "franchise-skater-records"
    
    if (is.null(name) & is.null(id)){
      full_url <- paste0(base_url,"/", endpoint)
    }
    else {
      if (!is.null(id)) {
        full_url <- paste0(base_url,"/", endpoint, "?cayenneExp=franchiseId=", id)
      }
      if (!is.null(name)) {
        v <- c("Montreal Canadiens", "Montreal Wanderers", "St. Louis Eagles", "Hamilton Tigers",
               "Toronto Maple Leafs", "Boston Bruins", "Montreal Maroons", "Brooklyn Americans",
               "Philadelphia Quakers", "New York Rangers", "Chicago Blackhawks", "Detroit Red Wings",
               "Cleveland Barons", "Los Angeles Kings", "Dallas Stars", "Philadelphia Flyers", 
               "Pittsburgh Penguins", "St. Louis Blues", "Buffalo Sabres", "Vancouver Canucks", 
               "Calgary Flames", "New York Islanders", "New Jersey Devils", "Washington Capitals",
               "Edmonton Oilers", "Carolina Hurricanes", "Colorado Avalanche", "Arizona Coyotes",
               "San Jose Sharks", "Ottawa Senators", "Tampa Bay Lightning", "Anaheim Ducks",
               "Florida Panthers", "Nashville Predators", "Winnipeg Jets", "Columbus Blue Jackets",
               "Minnesota Wild", "Vegas Golden Knights", "Seattle Kraken")
        nameid <- match(name, v)
        full_url <- paste0(base_url,"/", endpoint,"?cayenneExp=franchiseId=", nameid)
      }
    }
  }
  
  #Sixth endpoint: has name/id specification by mostRecentTeamId instead of franchiseId
  if (input == "history"){
    endpoint <- "franchise-detail"
    if (is.null(name) & is.null(id)){
      full_url <- paste0(base_url, "/", endpoint)
    }
    else {
      if (!is.null(id)) {
        full_url <- paste0(base_url, "/", endpoint, "?cayenneExp=mostRecentTeamId=", id)
      }
      if (!is.null(name)) {
        u <- c("New Jersey Devils", "New York Islanders", "New York Rangers", "Philadelphia Flyers",
               "Pittsburgh Penguins", "Boston Bruins", "Buffalo Sabres", "Montreal Canadiens",
               "Ottawa Senators", "Toronto Maple Leafs", "Carolina Hurricanes", "Florida Panthers",
               "Tampa Bay Lightning", "Washington Capitals", "Chicago Blackhawks", 
               "Detroit Red Wings", "Nashville Predators", "St. Louis Blues", "Calgary Flames", 
               "Colorado Avalanche", "Edmonton Oilers", "Vancouver Canucks", "Anaheim Ducks", 
               "Dallas Stars","Los Angeles Kings", "San Jose Sharks", "Columbus Blue Jackets", 
               "Minnesota Wild", "Hamilton Tigers", "Philadelphia Quakers", "Montreal Wanderers",
               "Montreal Maroons","St. Louis Eagles", "Cleveland Barons", "Brooklyn Americans",
               "Winnipeg Jets", "Arizona Coyotes", "Vegas Golden Knights", "Seattle Kraken")
        nameid <- match(name, u)
        unum <- c(1:10, 12:30, seq(37,45,by=2), 49, 51:55)
        full_url <- paste0(base_url,"/", endpoint, "?cayenneExp=mostRecentTeamId=", unum[nameid])
      }
    }
  }
  x <- GET(full_url)           #Retrieving data from URL
  y <- content(x, as = "text") #Converiting it to JSON text
  z <- fromJSON(y)             #Converting to list
  as.data.frame(z$data)        #Converting to data frame
}
```

Below are some examples of how to use the function. The first outputs all of the franchise information. The second shows how adding an `id` (or `name`) argument will not affect the `"teamtotal"` (and `"franchise"`) inputs. The third shows all season records, but can also have a specification of `id` or `name`. The fourth shows goalie information for the team with 1 as the `franchiseId`. The fifth shows the skater inforamtion for the team with `name` Carolina Hurricanes. The sixth shows the admin history and retired numbers for the team with 1 as the `mostRecentTeamId`.

```{r, message = FALSE}
## Examples:
#Franchise information
franchise <- getRecords("franchise")

#Total stats for every franchise
total <- getRecords("teamtotal", id=1)

#Season records for specific franchise or for all 
season <- getRecords("season")

#Goalie records for specific franchise
goalie <- getRecords("goalie", id=1)

#Skater records for for specific franchise
skater <- getRecords("skater", name = "Carolina Hurricanes")

#Admin history and retired numbers, Note: id is mostRecentTeamId
admin <- getRecords("history", id=1)
```

## NHL stats API

The `getStats` function will contact the [NHL stats API](https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md) for the modifier and will output a data frame for a specified team or all teams. The arguments `recentId` and `name` can be specified if we want to look at a specific team. Otherwise, we can leave the arguments empty to output all teams stats.

Note: The Seattle Kraken is a new team that joined in 2021, so there is no current data on them. 

```{r}
getStats <- function(name = NULL, recentId = NULL){
  base_url <- "https://statsapi.web.nhl.com/api/v1/teams"
  
  #function to get the data into a useable form
  getData <- function(url){
    x <- GET(full_url)
    y <- content(x, as = "text")
    fromJSON(y)
  }
  
  if (is.null(name) & is.null(recentId)){
      full_url <- paste0(base_url, "?expand=team.stats")
      z <- getData(full_url)
      df <- NULL
      for (i in 1:31){
        #selecting stats
        a <- z$teams[i,]$teamStats[[1]]$splits[[1]]$stat[1,]
        #id and names for the teams
        b <- z$teams[i,][,c("id","name")]
        #combining the two
        c <- cbind(b,a)
        #adding the new row to the data frame
        df <- rbind(df,c)
      }
      df
    }
    else {
      if (!is.null(recentId)) {
        if (recentId == 55){
          stop("Seattle Kraken is a new team in the NHL (as of 2021), 
               so there is no data on them")
        }
        full_url <- paste0(base_url, "/", recentId, "?expand=team.stats")
      }
      if (!is.null(name)) {
        u <- c("New Jersey Devils", "New York Islanders", "New York Rangers", "Philadelphia Flyers",
               "Pittsburgh Penguins", "Boston Bruins", "Buffalo Sabres", "Montreal Canadiens",
               "Ottawa Senators", "Toronto Maple Leafs", "Carolina Hurricanes", "Florida Panthers",
               "Tampa Bay Lightning", "Washington Capitals", "Chicago Blackhawks", 
               "Detroit Red Wings", "Nashville Predators", "St. Louis Blues", "Calgary Flames", 
               "Colorado Avalanche", "Edmonton Oilers", "Vancouver Canucks", "Anaheim Ducks", 
               "Dallas Stars","Los Angeles Kings", "San Jose Sharks", "Columbus Blue Jackets", 
               "Minnesota Wild", "Hamilton Tigers", "Philadelphia Quakers", "Montreal Wanderers",
               "Montreal Maroons","St. Louis Eagles", "Cleveland Barons", "Brooklyn Americans",
               "Winnipeg Jets", "Arizona Coyotes", "Vegas Golden Knights", "Seattle Kraken")
        nameid <- match(name, u)
        unum <- c(1:10, 12:26, 28:30, seq(37,45,by=2), 49, 51:55)
        if (unum[nameid] == 55){
          stop("Seattle Kraken is a new team in the NHL (as of 2021), 
               so there is no data on them")
        }
        full_url <- paste0(base_url, "/", unum[nameid], "?expand=team.stats")
      }
      z <- getData(full_url)
      #selecting stats
      a <- z$teams[1,]$teamStats[[1]]$splits[[1]]$stat[1,]
      #id and names for the teams
      b <- z$teams[1,][,c("id","name")]
      #combining the two
      cbind(b,a)
    }
}
```

Below are examples of calling the `getStats` function. The first example calls all teams and the second calls the first team. The third calls for the team named Seattle Kraken, which is a new team in the NHL (as of 2021), so there is currently no data on them in the API.

```{r, error = TRUE}
## Examples
#All stats for all teams
all <- getStats()

#For a specific team
team1 <- getStats(recentId = 1)

#For Seattle Kraken (recentId = 55)
getStats(name = "Seattle Kraken")
```

## API wrapper

The `getEndpoint` function is a wrapper function that allows the user to access any of the six API endpoints of `getRecords` or the stats from `getStats` including the modification for selecting the team using `name` or `id`. The `input` argument takes the six choices from `getRecords` and a new choice `"stats"`, which will output `getStats` for all or a specified team.

```{r}
getEndpoint <- function(input, name = NULL, id = NULL){
  if (input == "stats"){
    getStats(name, recentId = id)
  }
  else {
    getRecords(input, name, id)
  }
}
```

# Exploratory Data Analysis

The data is from over a year ago, but I decided to focus on the skaters and goalies that were considered active. For some of the graphs I chose to compare the Carolina Hurricanes and Tampa Bay Lightning. I selected these two teams because the Carolina Hurricanes are the home team of North Carolina and the Tampa Bay Lightning were the 2020 Stanley Cup winners and the team that recently beat the Hurricanes for the semifinal spot for the 2021 Stanley Cup. 

New variables of interest:
* For skaters:
    + `ppg` or points per game which is to determine their average points in the number of games they have played
* For goalies:
    + `winPercent` which follows the formula given in [this](http://hockeygoalies.org/stats/glossary.html) website
    + `positionCode` to match the skaters when combining the datasets

```{r, message = FALSE}
##Each team's skaters:
#Tampa Bay Lightning
skateLightning <- getEndpoint("skater", name = "Tampa Bay Lightning")
#Carolina Hurricanes
skateHurricane <- getEndpoint("skater", name = "Carolina Hurricanes")

#Combining the datasets, choosing only active players, and variables of interest
#New variable: ppg
skateTBLvsCH <- rbind(skateLightning, skateHurricane) %>% 
  filter(activePlayer == TRUE) %>%
  select(franchiseName, playerId, positionCode, gamesPlayed, assists, goals, points, 
         penaltyMinutes) %>% 
  mutate(ppg = points/gamesPlayed)

#Converting the variables to factors and labeling levels
skateTBLvsCH$positionCode <- factor(skateTBLvsCH$positionCode, 
                                     c("C", "D", "L", "R"), 
                                     c("Center", "Defence", "Left Wing", "Right Wing"))

##Each team's goalies:
#Tampa Bay Lightning
goalLightning <- getEndpoint("goalie", name = "Tampa Bay Lightning")
#Carolina Hurricanes
goalHurricane <- getEndpoint("goalie", name = "Carolina Hurricanes")

#Combining the datasets, choosing only active players, and variables of interest
#New variable: winPercent and positionCode
goalTBLvsCH <- rbind(goalLightning, goalHurricane) %>% 
  filter(activePlayer == TRUE) %>%
  select(franchiseName, playerId, gamesPlayed, losses, wins, ties, overtimeLosses, shutouts) %>%
  replace_na(list(ties = 0)) %>% 
  mutate(winPercent = ((2*wins)+ ties + overtimeLosses)/(2*(wins + losses + ties + overtimeLosses)), 
         positionCode = "Goalie")

#All players on the two teams - essentially like a roster
skateroster <- skateTBLvsCH %>% select(franchiseName, playerId, positionCode, gamesPlayed)
goalroster <- goalTBLvsCH %>% select(franchiseName, playerId, positionCode, gamesPlayed)
rosterTBLvsCH <- rbind(skateroster, goalroster)

#All active goalies in the NHL with variables of interest and new variable winPercent
allGoalie <- getEndpoint(input = "goalie") %>% 
  filter(activePlayer == TRUE) %>%
  select(franchiseName, playerId, gamesPlayed, losses, wins, ties, overtimeLosses, shutouts) %>%
  mutate(winPercent=((2*wins)+ ties + overtimeLosses)/(2*(wins + losses + ties + overtimeLosses))) %>%
  replace_na(list(ties = 0, overTimeLosses = 0, winPercent = 0))
```

## Contingency tables

The following table and barplot display the active players by their positions in their respective teams. We can see that the Carolina Hurricanes had more players on their team since they have more centers, defence, and left wing and the same number of goalies and right wing as the Tampa Bay Lightning.

```{r}
#Table for franchiseName by positionCode
kable(table(rosterTBLvsCH$franchiseName, rosterTBLvsCH$positionCode),
             caption = "Players in each team by position information")
```

## Bar plot

The bar plot below visually displays the data from the table above.

```{r}
ggplot(rosterTBLvsCH, aes(positionCode, fill = franchiseName)) + 
  geom_bar(position = "dodge") +
  labs(title = "Players of each team by position", x = "Position")
```

## Numerical Summaries

Suppose we want to investigate of the data for skaters, by team or for all skaters. The `getSummary` function will takes in the team and position for active skaters that we are interested in and outputs a the five number summary for the assists, goals, points, and penalty Minutes. 

```{r}
getSkaterSummary <- function(position, name = NULL){
  skatePosition <- getEndpoint("skater", name)
  new <- skatePosition %>% filter(activePlayer == TRUE & positionCode == position) %>%
    select(assists, goals, points, penaltyMinutes)
  if (position == "C")
     type = "Center"
  if (position == "D")
     type = "Defence"
  if (position == "L")
     type = "Left Wing"
  if (position == "R")
     type = "Right Wing"
  if (is.null(name)){
    main <- paste0("Summary of ", type)
  }
  else {
    main <- paste0("Summary of ", type, " for ", name)
  }
  kable(apply(new, 2, summary), caption = main)
}
```

When we look at the data for players on the Carolina Hurricanes we can see that the minimum assists, goals, points, and penalty minutes is usually zero across all positions, except left wing players that have four minutes as the minimum penalty minutes. The left wing players also have a larger value for the first quartile for all variables. The right wing players have small values for the first quartile and median, but as we saw from the bar graph, we know there are fewer left wing players than the other three positions (center, denfense, and left wing).

```{r, message = FALSE}
getSkaterSummary(position = "C", name = "Carolina Hurricanes")
getSkaterSummary(position = "D", name = "Carolina Hurricanes")
getSkaterSummary(position = "L", name = "Carolina Hurricanes")
getSkaterSummary(position = "R", name = "Carolina Hurricanes")
```

## Box plot

If we were interested in seeing the points per game of the skaters. The players with positions center, defense, and left wing have similar plots between the two teams. Some slight differences is the center on the Tampa Bay Lightnings with over 0.9 points per game. On the Carolina Hurricanes, the defense player with over 0.6 points per game is an outlier, but for Tampa Bay, the player with over 0.6 points per game is still within the whisker of the boxplot. The most noticable difference between the two teams are in the right wing boxplot. First the inter quartile range for the Tampa Bay Lightning is much smaller than the Carolina Hurricanes and they also have an outlier that is over 0.9 points per game. 

```{r}
ggplot(skateTBLvsCH, aes(positionCode, ppg)) +
  geom_boxplot() +
  geom_jitter(aes(color = positionCode)) + 
  facet_wrap(~franchiseName) +
  labs(title = "Boxplot for points per game", x = "player positon", y = "points per game")
```

## Histogram

### Points per game
Using a historgram we can roughly see what the density of the player's points per game for each team. We can see that the majority of the data from 0 to 0.9 points per game. We can also see Tampa Bay Lighting has players who score at least one point per game they play, while the Carolina Hurricanes all stay below one point per game.

```{r}
#Separated histograms for each team
ggplot(skateTBLvsCH, aes(ppg)) +
  geom_histogram(aes(y = ..density..), bins = 15) + 
  geom_density(color = "red") +
  labs(title = "Histogram for points per game by team", x = "Points per game")
```

### Win Percent

From the histogram of win percent for all goalies in the NHL, we can see many stay are close to zero, which logically makes sense. For example, the Carolina Hurricanes and Tampa Bay Lightning had five goalies. Assuming they have two to three main goalies then many of the goalies would not have many opportunities to play and therefore have a zero win percentage. If we ignore the zero percent win rate, then the data from around 0.3 to 0.6 contain the majority of win percentages and few goalies are above/below that range. 

```{r}
#A histogram for all goalies in the NHL
ggplot(allGoalie, aes(winPercent)) +
  geom_histogram(aes(y = ..density..), bins = 15) +
  labs(title = "Histogram for Win Percent of All Goalies in NHL", x = "Win Percent")
```

## Scatter plot

Looking at the scatterplots for the number of games played versus the points per game, we can see that there is generally a positive trend for both teams. This makes sense since there is more opportunity to obtain points by playing in more games.

```{r}
ggplot(skateTBLvsCH, aes(gamesPlayed, points, col = franchiseName)) + 
  geom_point() + 
  labs(title = "Games Played vs Points", x = "Games Played", y = "Points")
```
